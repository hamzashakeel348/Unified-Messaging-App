"use strict";(()=>{var e={};e.id=884,e.ids=[884],e.modules={1185:e=>{e.exports=require("mongoose")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7248:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>f,patchFetch:()=>S,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var i={};n.r(i),n.d(i,{POST:()=>_,dynamic:()=>m,runtime:()=>l});var a=n(9303),r=n(8716),o=n(670),s=n(7070),d=n(5748),p=n(9312),u=n(1221),c=n(9520);let l="nodejs",m="force-dynamic";async function _(e){if(!function(e){let t=process.env.UNIPILE_WEBHOOK_SECRET;return!t||e.headers.get("Unipile-Auth")===t}(e))return s.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,c.N)(e);if(await (0,d.C)(),t?.event&&"string"==typeof t?.event&&t?.chat_id&&t?.message_id&&t?.account_type&&"LINKEDIN"===(t.account_type||"").toUpperCase()){let e=t?.sender?.attendee_name||t?.sender?.attendee_provider_id||"unknown",n=Array.isArray(t?.attendees)&&t.attendees[0]?.attendee_name?t.attendees[0].attendee_name:"unknown";await p.Z.updateOne({message_id:t.message_id},{$setOnInsert:{platform:"linkedin",message_id:t.message_id,chat_id:t.chat_id,from:e,to:n,text:t?.message||"",created_at:new Date(t?.timestamp||Date.now())}},{upsert:!0})}if(t?.email_id&&t?.account_id&&t?.event&&t?.from_attendee){let e=t?.from_attendee?.identifier||"unknown",n=Array.isArray(t?.to_attendees)&&t.to_attendees[0]?.identifier?t.to_attendees[0].identifier:"unknown";await p.Z.updateOne({message_id:t.email_id},{$setOnInsert:{platform:"google",account_id:t.account_id,message_id:t.email_id,provider_message_id:t?.message_id,email_id:t.email_id,from:e,to:n,subject:t?.subject||"",text:t?.body_plain||t?.body||"",created_at:new Date(t?.date||Date.now())}},{upsert:!0})}return t?.status&&t?.account_id&&t?.type==="ACCOUNT_STATUS"&&await u.Z.updateOne({unipile_account_id:t.account_id},{$set:{platform:(t?.provider||"").toLowerCase()}},{upsert:!0}),s.NextResponse.json({ok:!0})}let g=new a.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/webhooks/unipile/route",pathname:"/api/webhooks/unipile",filename:"route",bundlePath:"app/api/webhooks/unipile/route"},resolvedPagePath:"/Users/hamzashakeel/Desktop/unipile-inbox-mvp-webhooks/src/app/api/webhooks/unipile/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:w}=g,f="/api/webhooks/unipile/route";function S(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},5748:(e,t,n)=>{n.d(t,{C:()=>s});var i=n(1185),a=n.n(i);let r=process.env.MONGODB_URI;if(!r)throw Error("Missing MONGODB_URI");let o=global._mongoose;async function s(){return o.conn||(o.promise||(o.promise=a().connect(r,{dbName:"unipile_inbox_mvp"}).then(e=>e)),o.conn=await o.promise),o.conn}o||(o=global._mongoose={conn:null,promise:null})},1221:(e,t,n)=>{n.d(t,{Z:()=>r});var i=n(1185);let a=new i.Schema({platform:{type:String,enum:["google","linkedin"],required:!0},unipile_account_id:{type:String,required:!0,unique:!0},label:{type:String},email:{type:String},linkedin_profile:{type:String},user_name:{type:String}},{timestamps:!0}),r=i.models.Account||(0,i.model)("Account",a)},9312:(e,t,n)=>{n.d(t,{Z:()=>r});var i=n(1185);let a=new i.Schema({platform:{type:String,enum:["google","linkedin"],required:!0},account_id:{type:String},message_id:{type:String,required:!0,unique:!0},provider_message_id:{type:String},chat_id:{type:String},email_id:{type:String},from:{type:String,required:!0},to:{type:String,required:!0},subject:{type:String},text:{type:String},created_at:{type:Date,default:Date.now}},{timestamps:!0}),r=i.models.Message||(0,i.model)("Message",a)},9520:(e,t,n)=>{n.d(t,{N:()=>i});async function i(e){try{return await e.json()}catch{let t=await e.text();try{return JSON.parse(t)}catch{return{}}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),i=t.X(0,[948,972],()=>n(7248));module.exports=i})();